name: Build Signed Release APK

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'
    branches:
      - 'release/**'

jobs:
  build-release:
    name: Build and Sign Release APK
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Decode and setup keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEY_STORE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "::error::KEY_STORE secret is not set"
            exit 1
          fi
          
          # Decode keystore from base64
          echo "$KEYSTORE_BASE64" | base64 --decode > keystore.jks
          
          # Add signing configuration to gradle.properties
          echo "androidStorePassword=$KEYSTORE_PASSWORD" >> gradle.properties
          echo "androidKeyAlias=$KEY_ALIAS" >> gradle.properties
          echo "androidKeyPassword=$KEY_PASSWORD" >> gradle.properties
          echo "androidStoreFile=keystore.jks" >> gradle.properties
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Build Release APKs
        run: |
          ./gradlew assembleWhatsappRelease assembleBusinessRelease --stacktrace
          
      - name: Get version info
        id: version
        run: |
          VERSION_NAME=$(grep "versionName" app/build.gradle.kts | awk '{print $3}' | tr -d '"')
          VERSION_CODE=$(grep "versionCode" app/build.gradle.kts | awk '{print $3}')
          SHORT_SHA=$(echo ${GITHUB_SHA} | cut -c1-8)
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "RELEASE_NAME=WaEnhancer-${VERSION_NAME}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          
      - name: Rename APK files
        run: |
          mkdir -p release-apks
          cp app/build/outputs/apk/whatsapp/release/app-whatsapp-release.apk \
             release-apks/WaEnhancer-${{ steps.version.outputs.VERSION_NAME }}-whatsapp.apk
          cp app/build/outputs/apk/business/release/app-business-release.apk \
             release-apks/WaEnhancer-${{ steps.version.outputs.VERSION_NAME }}-business.apk
             
      - name: Generate checksums
        run: |
          cd release-apks
          sha256sum *.apk > checksums.txt
          cat checksums.txt
          
      - name: Upload WhatsApp Release APK
        uses: actions/upload-artifact@v5
        with:
          name: WaEnhancer-WhatsApp-${{ steps.version.outputs.SHORT_SHA }}
          path: release-apks/WaEnhancer-${{ steps.version.outputs.VERSION_NAME }}-whatsapp.apk
          retention-days: 90
          
      - name: Upload Business Release APK
        uses: actions/upload-artifact@v5
        with:
          name: WaEnhancer-Business-${{ steps.version.outputs.SHORT_SHA }}
          path: release-apks/WaEnhancer-${{ steps.version.outputs.VERSION_NAME }}-business.apk
          retention-days: 90
          
      - name: Upload Checksums
        uses: actions/upload-artifact@v5
        with:
          name: checksums-${{ steps.version.outputs.SHORT_SHA }}
          path: release-apks/checksums.txt
          retention-days: 90
          
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: ${{ steps.version.outputs.RELEASE_NAME }}
          body_path: changelog.txt
          draft: false
          prerelease: false
          files: |
            release-apks/*.apk
            release-apks/checksums.txt
            
      - name: Post to Telegram (if configured)
        if: success() && secrets.BOT_TOKEN != ''
        env:
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          VERSION: ${{ steps.version.outputs.VERSION_NAME }}
        run: |
          if [ ! -z "$BOT_TOKEN" ]; then
            CHANGELOG=$(cat changelog.txt | head -20)
            MESSAGE="ðŸš€ *WaEnhancer ${VERSION} Release*%0A%0A${CHANGELOG}"
            
            # Send WhatsApp APK
            curl -F chat_id="${CHANNEL_ID}" \
                 -F document=@"release-apks/WaEnhancer-${VERSION}-whatsapp.apk" \
                 -F caption="ðŸ“± WaEnhancer ${VERSION} - WhatsApp" \
                 "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument"
                 
            # Send Business APK
            curl -F chat_id="${CHANNEL_ID}" \
                 -F document=@"release-apks/WaEnhancer-${VERSION}-business.apk" \
                 -F caption="ðŸ’¼ WaEnhancer ${VERSION} - Business%0A%0A${MESSAGE}" \
                 "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument"
          fi
          
      - name: Cleanup keystore
        if: always()
        run: |
          rm -f keystore.jks
          rm -f key.jks
